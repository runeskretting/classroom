{% extends "base.html" %}

{% block title %}My Progress - Python Classroom{% endblock %}

{% block content %}
<div class="progress-page">
    <div class="progress-header">
        <h1>My Progress</h1>
        <p class="student-name">{{ student_name }}</p>
    </div>

    {% if progress.completed %}
        <div class="completion-banner">
            <h2>ðŸŽ‰ Congratulations!</h2>
            <p>You have successfully completed all modules of the Python Classroom!</p>
            <p class="completion-date">Completed: {{ progress.completed_at }}</p>
        </div>
    {% else %}
        <div class="current-progress">
            <h3>Currently on: Day {{ progress.current_module }}</h3>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (progress.current_module - 1) / 100 * 100 }}%"></div>
            </div>
            <p class="progress-text">{{ progress.current_module - 1 }} of 100 days completed</p>
        </div>
    {% endif %}

    <div class="modules-progress">
        {# Separate modules into categories #}
        {% set completed_modules = [] %}
        {% set locked_modules = [] %}
        {% set current_module_id = progress.current_module %}

        {% for module_id in modules.keys()|sort %}
            {% set module_progress = progress.modules.get(module_id, {'quiz_passed': False, 'project_passed': False, 'quiz_score': 0, 'attempts': 0}) %}
            {% set is_complete = module_progress.quiz_passed and module_progress.project_passed %}

            {% if is_complete %}
                {% set _ = completed_modules.append(module_id) %}
            {% elif module_id > current_module_id %}
                {% set _ = locked_modules.append(module_id) %}
            {% endif %}
        {% endfor %}

        {# Current Module - Always visible and highlighted #}
        {% if current_module_id in modules %}
            {% set module = modules[current_module_id] %}
            {% set module_progress = progress.modules.get(current_module_id, {'quiz_passed': False, 'project_passed': False, 'quiz_score': 0, 'attempts': 0}) %}

            <div class="current-module-section">
                <h2 class="section-title">Current Day</h2>
                <div class="module-progress-card current-module">
                    <div class="module-progress-header">
                        <div class="module-number-badge">
                            {{ current_module_id }}
                        </div>
                        <div>
                            <h3>{{ module.title }}</h3>
                            <p class="module-objective">{{ module.objective }}</p>
                        </div>
                    </div>

                    <div class="module-progress-details">
                        <div class="progress-item">
                            <span class="progress-label">Quiz:</span>
                            {% if module_progress.quiz_passed %}
                                <span class="badge badge-success">âœ“ Passed ({{ module_progress.quiz_score }}%)</span>
                            {% else %}
                                <span class="badge badge-pending">Not Completed</span>
                            {% endif %}
                        </div>

                        <div class="progress-item">
                            <span class="progress-label">Project:</span>
                            {% if module_progress.project_passed %}
                                <span class="badge badge-success">âœ“ Passed</span>
                            {% elif module_progress.attempts > 0 %}
                                <span class="badge badge-warning">{{ module_progress.attempts }} attempt(s)</span>
                            {% else %}
                                <span class="badge badge-pending">Not Submitted</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="module-progress-actions">
                        <a href="{{ url_for('module', module_id=current_module_id) }}" class="btn btn-primary btn-small">
                            {% if module_progress.quiz_passed %}
                                Submit Project
                            {% else %}
                                Start Day
                            {% endif %}
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}

        {# Completed Modules - Collapsible #}
        {% if completed_modules|length > 0 %}
            <details class="module-group">
                <summary class="section-title">
                    <span class="expand-icon">â–¶</span>
                    Completed Days ({{ completed_modules|length }})
                </summary>
                <div class="module-group-content">
                    {% for module_id in completed_modules|reverse %}
                        {% set module = modules[module_id] %}
                        {% set module_progress = progress.modules.get(module_id, {'quiz_passed': False, 'project_passed': False, 'quiz_score': 0, 'attempts': 0}) %}

                        <div class="module-progress-card completed">
                            <div class="module-progress-header">
                                <div class="module-number-badge">
                                    <span class="checkmark">âœ“</span>
                                </div>
                                <div>
                                    <h3>{{ module.title }}</h3>
                                    <p class="module-objective">{{ module.objective }}</p>
                                </div>
                            </div>

                            <div class="module-progress-details">
                                <div class="progress-item">
                                    <span class="progress-label">Quiz:</span>
                                    <span class="badge badge-success">âœ“ Passed ({{ module_progress.quiz_score }}%)</span>
                                </div>

                                <div class="progress-item">
                                    <span class="progress-label">Project:</span>
                                    <span class="badge badge-success">âœ“ Passed</span>
                                </div>
                            </div>

                            <div class="module-progress-actions">
                                <a href="{{ url_for('module', module_id=module_id) }}" class="btn btn-secondary btn-small">
                                    Review
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </details>
        {% endif %}

        {# Locked Modules - Collapsible #}
        {% if locked_modules|length > 0 %}
            <details class="module-group">
                <summary class="section-title">
                    <span class="expand-icon">â–¶</span>
                    Locked Days ({{ locked_modules|length }})
                </summary>
                <div class="module-group-content">
                    {% for module_id in locked_modules %}
                        {% set module = modules[module_id] %}

                        <div class="module-progress-card locked">
                            <div class="module-progress-header">
                                <div class="module-number-badge">
                                    <span class="lock">ðŸ”’</span>
                                </div>
                                <div>
                                    <h3>{{ module.title }}</h3>
                                    <p class="module-objective">{{ module.objective }}</p>
                                </div>
                            </div>

                            <div class="module-progress-details">
                                <div class="progress-item">
                                    <span class="progress-label">Quiz:</span>
                                    <span class="badge badge-locked">Locked</span>
                                </div>

                                <div class="progress-item">
                                    <span class="progress-label">Project:</span>
                                    <span class="badge badge-locked">Locked</span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </details>
        {% endif %}
    </div>

    <div class="stats-section">
        <h3>Statistics</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ progress.current_module - 1 }}</div>
                <div class="stat-label">Days Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% set total_attempts = namespace(value=0) %}
                    {% for module_id, module_data in progress.modules.items() %}
                        {% set total_attempts.value = total_attempts.value + module_data.attempts %}
                    {% endfor %}
                    {{ total_attempts.value }}
                </div>
                <div class="stat-label">Total Attempts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% set quizzes_passed = namespace(value=0) %}
                    {% for module_id, module_data in progress.modules.items() %}
                        {% if module_data.quiz_passed %}
                            {% set quizzes_passed.value = quizzes_passed.value + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ quizzes_passed.value }}
                </div>
                <div class="stat-label">Quizzes Passed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% set projects_passed = namespace(value=0) %}
                    {% for module_id, module_data in progress.modules.items() %}
                        {% if module_data.project_passed %}
                            {% set projects_passed.value = projects_passed.value + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ projects_passed.value }}
                </div>
                <div class="stat-label">Projects Passed</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
